<!-- results.html

on the page, we show the map the user has created, as well as the directions
we want to show directions as a list within a div

create a for loop that creates lines in the list once the direction list has loaded
to do - - need to determine if i can parse directions and have each directions show as a <li>
 -->

{% extends 'base.html' %}

{% block content %}


<form id='dest-details' action='/poke-map.json' method='GET'>
    <label for='start-point'>start point:
        <input id='start-point' type='text' name='start-point' value='730 Howard St San Francisco, CA 94103'>
    </label><br>
    <label for='end-point'>end point:
        <input id='end-point' type='text' name='end-point' value='24 Willie Mays Plaza, San Francisco, CA 94107'>
    </label><br>
    <label for='departure-time'>time of departure:
        <select id='departure-time' name='departure-time'>
            <option value='6:00 pm'>6:00 pm</option>
            <option value='7:00 pm'>7:00 pm</option>
            <option value='8:00 pm'>8:00 pm</option>
            <option value='9:00 pm'>9:00 pm</option>
            <option value='10:00 pm'>10:00 pm</option>
            <option value='11:00 pm'>11:00 pm</option>
            <option value='12:00 am'>12:00 am</option>
        </select>
    </label><br>
    <input type='submit' id='submit-destination' href='#' value='take me there'>
</form>

<div id='map' style='height:700px'></div>
<div id="directions-panel"></div>

<script src="https://code.jquery.com/jquery.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places&key=AIzaSyDsAgJV6GObnh7-vt-hrQBm5beRdowkZxs&callback=initMap" async defer></script>

<!-- REMOVE CALLBACK AND ONLY RUN ON CLICK? -->

<script>
"use strict";

  function initMap() {
    // required google maps initiation f(x)
    var directionsService = new google.maps.DirectionsService;
    var directionsDisplay = new google.maps.DirectionsRenderer;
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 16,
      center: {lat: 37.781602, lng: -122.396885}
    });
    // display map
    directionsDisplay.setMap(map);

    console.log('show map');

    // declare empty arrays to hold latlng objects that are created
    var waypoints = [];
    var markers = [];

    // on click, get json from server (automatically parsed)
    $('#submit-destination').click( function(evt) {
      evt.preventDefault();

      $.get('poke-map.json', function(data) {
        var locObject = data['locations']; // declare location object from data
        var gymObject = data['gyms']; // declare gym object
        var encObject = data['encounters']; // declare encounter object

        $.each(locObject, function(key, value) { 
          var locLat = locObject[key]['latitude'] // get each latitude from obj
          var locLng = locObject[key]['longitude'] // get each longitude from obj
          // waypoints.push({lat:locLat, lng:locLng});
          var waypoint = new google.maps.LatLng(locLat, locLng);
          waypoints.push({location:waypoint, stopover:true});
        });

        $.each(gymObject, function(key, value){
          var gymLat = gymObject[key]['latitude'] // get each latitude from obj
          var gymLng = gymObject[key]['longitude'] // get each longitude from obj

          var myPosition = {lat:gymLat, lng:gymLng};
          var gymImage = {url:"https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/battle.png", 
            scaledSize: new google.maps.Size(42,42)};
          var marker = new google.maps.Marker({position: myPosition, 
                              map: map,
                              icon: gymImage, 
                              title: "Gym"});
          markers.push(marker);
        });

        $.each(encObject, function(key, value){
          var encLat = encObject[key]['latitude'] // get each latitude from obj
          var encLng = encObject[key]['longitude'] // get each longitude from obj
          var encPoke = encObject[key]['pokemon_id'] // get each pokemon_id

          var myPosition = {lat:encLat, lng:encLng};
          var encImage = {url:"https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/pokeball.png",
            scaledSize: new google.maps.Size(35,35)};
          var marker = new google.maps.Marker({position: myPosition, 
                              map: map,
                              icon: encImage, 
                              title: "Encounter"});
          markers.push(marker);

          // NEXT - determine how to get pokemon data into info boxes
        });

        // console.log(waypoints); // should return 8 objects (locations)
        // console.log(markers); // should return 11 objects (encounters & gyms)

        calculateAndDisplayRoute(directionsService, directionsDisplay, waypoints, markers); // add waypoints, markers

          // for (var i=0; i<waypoints.length; i++)
          // {}

      });
    });
  }

  //////////////////////////

  function calculateAndDisplayRoute(directionsService, directionsDisplay, waypoints, markers) {

    // console.log(waypoints); // should return 8 objects (locations)
    console.log(markers);

    directionsService.route({
      origin: new google.maps.LatLng(37.784097,-122.402033),
      destination: new google.maps.LatLng(37.779268,-122.390147),
      waypoints: waypoints,
      optimizeWaypoints: true,
      travelMode: 'WALKING'
    }, function(response, status) {
      if (status === 'OK') {
        directionsDisplay.setDirections(response);
        var route = response.routes[0];
        var summaryPanel = document.getElementById('directions-panel');
        summaryPanel.innerHTML = '';
        // For each route, display summary information.
        for (var i = 0; i < route.legs.length; i++) {
          var routeSegment = i + 1;
          summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
              '</b><br>';
          summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
          summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
          summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
        }
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });

  }

  //////////////////////////



</script>

{% endblock %}


