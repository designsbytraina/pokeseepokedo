<!-- index.html

on the page, we show the map the user has created, as well as the directions
we want to show directions as a list within a div

create a for loop that creates lines in the list once the direction list has loaded
to do - - need to determine if i can parse directions and have each directions show as a <li>
 -->

{% extends 'base.html' %}

{% block content %}


<form id='dest-details' action='/poke-map.json' method='GET'>
    <label for='start-point'>start point:
        <input id='start-point' type='text' name='start-point' value='730 Howard St San Francisco, CA 94103'>
    </label><br>
    <label for='end-point'>end point:
        <input id='end-point' type='text' name='end-point' value='24 Willie Mays Plaza, San Francisco, CA 94107'>
    </label><br>
    <label for='departure-time'>time of departure:
        <select id='departure-time' name='departure-time'>
            <option value='6:00 pm'>6:00 pm</option>
            <option value='7:00 pm'>7:00 pm</option>
            <option value='8:00 pm'>8:00 pm</option>
            <option value='9:00 pm'>9:00 pm</option>
            <option value='10:00 pm'>10:00 pm</option>
            <option value='11:00 pm'>11:00 pm</option>
            <option value='12:00 am'>12:00 am</option>
        </select>
    </label><br>
    <input type='submit' id='submit-destination' href='#' value='take me there'>
</form>

<div id='map' style='height:600px'></div>
<div id="directions-panel"></div>

<script src="https://code.jquery.com/jquery.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places&key=AIzaSyDsAgJV6GObnh7-vt-hrQBm5beRdowkZxs&callback=initMap" async defer></script>

<!-- REMOVE CALLBACK AND ONLY RUN ON CLICK? -->

<script>
"use strict";

  function initMap() {
    // required google maps initiation f(x)
    var directionsService = new google.maps.DirectionsService;
    var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers:true});
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: {lat: 37.781602, lng: -122.396885},
      styles: [
                {"featureType": "administrative.locality","elementType": "all","stylers": [{"visibility": "off"}]},
                {"featureType":"landscape.man_made","elementType":"geometry.fill","stylers":[{"color":"#a1f199"}]},
                {"featureType":"landscape.natural.landcover","elementType":"geometry.fill","stylers":[{"color":"#37bda2"}]},
                {"featureType":"landscape.natural.terrain","elementType":"geometry.fill","stylers":[{"color":"#37bda2"}]},
                {"featureType":"road","elementType":"geometry.fill","stylers":[{"color":"#84b09e"}]},
                {"featureType":"road","elementType":"geometry.stroke","stylers":[{"color":"#fafeb8"},{"weight":"1.25"}]},
                {"featureType":"road.highway","elementType":"labels.icon","stylers":[{"visibility":"off"}]},
                {"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#5ddad6"}]},
                {"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]}
              ]
    });

    // display map
    directionsDisplay.setMap(map);

    console.log('show map');

    // declare empty arrays to hold latlng objects that are created
    var waypoints = [];
    var markers = [];

    // on click, get json from server (automatically parsed)
    $('#submit-destination').click( function(evt) {
      evt.preventDefault();

      $.get('poke-map.json', function(data) {
        var locObject = data['locations']; // declare location object from data
        var gymObject = data['gyms']; // declare gym object
        var encObject = data['encounters']; // declare encounter object

        $.each(locObject, function(key, value) { 
          var locLat = locObject[key]['latitude'] // get each latitude from obj
          var locLng = locObject[key]['longitude'] // get each longitude from obj
          
          var locName = locObject[key]['name']
          var locRating = locObject[key]['rating']
          var locUrl = locObject[key]['url']
          var locCategory = locObject[key]['category']
          
          // create waypoint for stopover points
          var waypoint = new google.maps.LatLng(locLat, locLng);
          waypoints.push({location:waypoint, stopover:true});

          //create marker for waypoints so they show custom info
          var myPosition = {lat:locLat, lng:locLng};
          var locImage = {url: "https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/pokestop-2.png", 
            scaledSize: new google.maps.Size(50,50)}
          var marker = new google.maps.Marker({position: myPosition, 
                              map: map,
                              icon: locImage, 
                              title: "Location"});

          // content for infoWindow
          var contentString = '<h2>Name: ' + locName + '</h2>' + 
          '<h3>Yelp Rating: ' + locRating + '</h3>' + 
          '<h3>Category: ' + locCategory + '</h3>' +
          '<h3>Learn More: ' + locUrl + '</h3>' +
          '<p>Testing.</p>'+
          '<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. <br>Phasellus vestibulum risus at quam varius dictum.</p>';

          var infoWindow = new google.maps.InfoWindow({
            content: contentString
          });

          // want to use jquery here, just a placeholder
          marker.addListener('click', function() {
            infoWindow.open(map, marker);
          });

          markers.push(marker);
        });

        $.each(gymObject, function(key, value){
          var gymLat = gymObject[key]['latitude'] // get each latitude from obj
          var gymLng = gymObject[key]['longitude'] // get each longitude from obj
          var gymName = gymObject[key]['name']

          var myPosition = {lat:gymLat, lng:gymLng};
          var gymImage = {url:"https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/battle.png", 
            scaledSize: new google.maps.Size(50,50)};
          var marker = new google.maps.Marker({position: myPosition, 
                              map: map,
                              icon: gymImage, 
                              title: "Gym"});

          // content for infoWindow
          var contentString = '<h2>Name: ' + gymName + '</h2>' + 
          '<p>More testing.</p>';

          var infoWindow = new google.maps.InfoWindow({
            content: contentString
          });

          // want to use jquery here, just a placeholder
          marker.addListener('click', function() {
            infoWindow.open(map, marker);
          });

          markers.push(marker);
        });

        $.each(encObject, function(key, value){
          var encLat = encObject[key]['latitude'] // get each latitude from obj
          var encLng = encObject[key]['longitude'] // get each longitude from obj
          var encPoke = encObject[key]['pokemon_id']
          var pokemon = encObject[key]['name']
          var pokeHeight = encObject[key]['height']
          var pokeWeight = encObject[key]['weight']
          var pokeType = encObject[key]['type']
          var pokeNature = encObject[key]['nature']

          var myPosition = {lat:encLat, lng:encLng};
          var encImage = {url:"https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/pokeball.png",
            scaledSize: new google.maps.Size(35,35)};
          var marker = new google.maps.Marker({position: myPosition, 
                              map: map,
                              icon: encImage, 
                              title: "Encounter"});

          // content for infoWindow
          var contentString = '<div id="poke-info"><h2>Name: ' + pokemon + '</h2>' + 
          '<img src="https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/' + pokemon + '.png" alt=' + pokemon + ' height="65" width="auto">' +
          '<h3>Type: ' + pokeType + '</h3>' +
          '<h3>Height: ' + pokeHeight + '</h3>' +
          '<h3>Weight: ' + pokeWeight + '</h3>' +
          '<h3>Nature: ' + pokeNature + '</h3>' +
          '<form method="get" id="catch-poke" action="/catch-pokemon/' + 
          encPoke + '">' + '<input id="add-to-caught" type="image" ' +
          'src="https://raw.githubusercontent.com/designsbytraina/pokeseepokedo_0.5/master/assets_icons/gotcha.png" ' + 
          'alt="add to caught pokemon" height="50" width="auto">' + 
          '</form>';

          // create new InfoWindow object for use on marker click
          var infoWindow = new google.maps.InfoWindow({
            content: contentString
          });

          // upon clicking on a given marker, infoWindow will appear showing contentString
          marker.addListener('click', function() {
            infoWindow.open(map, marker);
          });

          markers.push(marker);

          // NEXT - determine how to get pokemon data into info boxes ^^^
          //https://developers.google.com/maps/documentation/javascript/examples/infowindow-simple
        });

        // console.log(waypoints); // should return 8 objects (locations)
        // console.log(markers); // should return 11 objects (encounters & gyms)

        calculateAndDisplayRoute(directionsService, directionsDisplay, waypoints, markers); // add waypoints, markers

          // for (var i=0; i<waypoints.length; i++)
          // {}

      });
    });
  }

  //////////////////////////

  function calculateAndDisplayRoute(directionsService, directionsDisplay, waypoints, markers) {

    // for (marker in markers) {

    //   // testing infowindow class creation to see if it can be done in initMap
    //   var infoWindow = new google.maps.InfoWindow({
    //     content: contentString
    //   });

    //   // want to use jquery here, just a placeholder
    //   marker.addListener('click', function() {
    //     infoWindow.open(map, marker);
    //   });
    // }

    // console.log(waypoints); // should return 8 objects (locations)
    // console.log(markers); // should return 11 objects (encounters & gyms)

    directionsService.route({
      origin: new google.maps.LatLng(37.784097,-122.402033),
      destination: new google.maps.LatLng(37.779268,-122.390147),
      waypoints: waypoints,
      optimizeWaypoints: true,
      travelMode: 'WALKING'
    }, function(response, status) {
      if (status === 'OK') {
        directionsDisplay.setDirections(response);
        var route = response.routes[0];
        var summaryPanel = document.getElementById('directions-panel');
        summaryPanel.innerHTML = '';
        // For each route, display summary information.
        for (var i = 0; i < route.legs.length; i++) {
          var routeSegment = i + 1;
          summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
              '</b><br>';
          summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
          summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
          summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
        }
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });

  }

  //////////////////////////



</script>

{% endblock %}


